# Agent Runtime - Isolated container for running agents
FROM node:20-alpine

WORKDIR /app

# Install useful tools for debugging
RUN apk add --no-cache bash curl jq git

# Copy package files
COPY package*.json ./
COPY packages/shared/package*.json ./packages/shared/
COPY packages/agent-runtime/package*.json ./packages/agent-runtime/
COPY packages/mcp-collective/package*.json ./packages/mcp-collective/
COPY packages/mcp-os/package*.json ./packages/mcp-os/
COPY packages/mcp-memory/package*.json ./packages/mcp-memory/

# Install dependencies
RUN npm ci

# Copy source
COPY packages/shared/ ./packages/shared/
COPY packages/agent-runtime/ ./packages/agent-runtime/
COPY packages/mcp-collective/ ./packages/mcp-collective/
COPY packages/mcp-os/ ./packages/mcp-os/
COPY packages/mcp-memory/ ./packages/mcp-memory/
COPY scripts/agent-bootstrap.sh /usr/local/bin/agent-bootstrap

# Build all agent-related packages
RUN npm run build -w @co-code/shared
RUN npm run build -w @co-code/agent-runtime
RUN npm run build -w @co-code/mcp-collective || true
RUN npm run build -w @co-code/mcp-os || true
RUN npm run build -w @co-code/mcp-memory || true

# Create agent home directory
RUN mkdir -p /home/agent/.co-code
ENV HOME=/home/agent

# Create workspace for agent to work in
RUN mkdir -p /workspace
WORKDIR /workspace

# Make bootstrap script executable
RUN chmod +x /usr/local/bin/agent-bootstrap

# Agent can access:
# - /workspace (for file operations)
# - /home/agent/.co-code (agent identity and memory)
# Agent cannot access:
# - Host filesystem (Docker isolation)

# Default command: shell for manual testing
CMD ["bash"]
